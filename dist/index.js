var e=({filter:e,action:i},{services:a,env:n})=>{const{AssetsService:s,FilesService:l}=a,o=n.EXTENSIONS_REDUCE_ON_UPLOAD_QUALITY||73,r=n.EXTENSIONS_REDUCE_ON_UPLOAD_MAXSIZE||1920;i("files.upload",(async({payload:e,key:i},a)=>{if(e.optimized)return;const[n,p]=e.type.split("/")??"";if("image"!==n&&"jpeg"!==p&&"webp"!==p&&"png"!==p)return;const d={format:"webp",quality:o,width:r,height:r,fit:"inside",withoutEnlargement:!1,transforms:[["withMetadata"]]},f={accountability:{admin:!0},knex:a.database,...a},w=new s(f),m=new l(f),{stream:c,file:u,stat:_}=await w.getAsset(i,{transformationParams:d});_.size>=e.filesize||("webp"!==p&&(e.type=e.type.replace(p,"webp"),e.filename_download=t(e.filename_download)+".webp",e.filename_disk=t(e.filename_disk)+".webp"),delete e.height,delete e.width,await async function(e){return new Promise((t=>setTimeout(t,e)))}(4e3),m.uploadOne(c,{...e,optimized:!0},i))}))};function t(e){return(e=e.split("/").pop().split(".")).length>1?e.slice(0,-1).join("."):e[0]}export{e as default};
